<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Flash Cards</title>

    <!-- Ubuntu font -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400&display=swap" rel="stylesheet">

    <!-- Include Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


	<!-- tailwind CDN -->
	<script src="https://cdn.tailwindcss.com"></script>

	<!-- <script src="./main.js" type="module" defer></script> -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Red:
    Hex: #A51931
    RGB: 165, 25, 49
    
    White:
    Hex: #FFFFFF
    RGB: 255, 255, 255
    
    Blue:
    Hex: #001A5D
    RGB: 0, 26, 93 -->
    <style>
        html {
            touch-action: manipulation;
        }
    </style>

</head>
<body class="bg-[#fbfcf8] text-[#2D2A4A] text-center">
    <h3 class="text-4xl p-5">Flash Cards</h3>
    <div class="flex flex-col justify-between gap-7" x-data="dropdown">
        <div class="w-4/5 md:w-1/4 mx-auto flex flex-col items-center justify-between gap-5 py-3 rounded-lg bg-white border-[#A51931] shadow-lg">
            <div class="grid grid-cols-2 w-2/3 mx-auto items-center">
                <div class="">
                    <label for="word_count" class="sr-only">Number of Consonants</label>
                    <input type="number" name="word_count" id="" class="w-2/3 rounded border-2 focus:border-solid focus:outline-none focus:border-[#2D2A4A] focus:shadow-lg py-1 text-center" x-model="consonant_count">
                </div>
                <fieldset class="flex items-center space-x-4 p-2">
                    <legend class="sr-only">Shuffle Options</legend>
                    <label class="flex items-center hover:cursor-pointer" for="random">
                        <input id="random" class="mr-1" type="checkbox" value="true" x-model="is_random"> Random
                    </label>
                </fieldset>
            </div>
            <button class="py-1 px-5 rounded bg-[#2D2A4A] text-white text-center" @click="generate">Generate</button>
            <!-- <button class="py-1 px-5 rounded bg-[#2D2A4A] text-white text-center" @click="generateFromAPI">Generate</button> -->
            
            
        </div>
        
        <!-- card -->
        <div x-show="show_cards && !loading" 
        x-transition:enter="transition duration-500"
        x-transition:enter-start="opacity-0 transform scale-98"
        x-transition:enter-end="opacity-100 transform scale-100"
        x-transition:leave="transition duration-500"
        x-transition:leave-start="opacity-100 transform scale-100"
        x-transition:leave-end="opacity-0 transform scale-98"
        class="flex flex-col justify-between items-center mx-auto rounded-lg p-2 w-4/5 md:w-1/4  border border-[#A51931] min-h-[400px] bg-white">
                <p 
                style="transition-timing-function: cubic-bezier(0.4, 0.0, 0.2, 1);"
                x-show="!loading"
                x-transition:enter="transition duration-500"
                x-transition:enter-start="opacity-0 transform scale-98"
                x-transition:enter-end="opacity-100 transform scale-100"
                x-transition:leave="transition duration-500"
                x-transition:leave-start="opacity-100 transform scale-100"
                x-transition:leave-end="opacity-0 transform scale-98"
                class="text-7xl" id="text-to-read" x-ref="text_to_read" x-text="question"></p>
                <div class="tabular-nums w-full p-2 flex items-center justify-between rounded border-2" :class="is_correct ? 'border-green-300 bg-green-100' : ' border-red-300 bg-red-100' " x-show="show_result">
                    <p class="text-lg" :class="is_correct ? 'text-green-600' : 'text-red-500' ">
                        <span x-show="is_correct">Correct</span>
                        <span x-show="!is_correct">Answer: <span x-text="correct_answer ? correct_answer.index + 1 : ''"></span></span>
                    </p>
                    <p class="text-2xl">
                        <i x-show="is_correct" class="text-green-600 fa-regular fa-circle-check"></i>
                        <i x-show="!is_correct" class="text-red-500 fa-regular fa-circle-xmark"></i>
                    </p>
                </div>
                <div class="grid grid-cols-2 gap-5 w-full">
                    <template x-for="(choice, index) in choices">
                        <div class="flex items-center justify-center p-4 rounded border-2 border-solid hover:cursor-pointer relative" :class="[index == selected_answer.index ? selected_border_style : '', show_result && (index == correct_answer.index) ? correct_border_style : '' ]" @click.stop="speakAnswer(choice, index)">
                             <!-- if click speak and select answer -->
                            <div class="top-0 left-0 absolute ml-1">
                                <p class="p-1" x-text="(index+1) + '.'"></p>
                                <span x-text="choice.word"></span>
                            </div>
                            <p x-show="!loading" class="p-1 text-2xl" id="read-btn" ><i class="fas fa-volume-up"></i></p>
                        </div>
                    </template>
                </div>
                <template x-if="!enable_chk_ans_btn">
                    <div class="flex justify-center items-center rounded w-full" :class="(!enable_chk_ans_btn && !show_next_btn) ? 'p-6' : 'p-1'">
                        <button 
                        x-show="show_next_btn"
                        x-transition:enter="transition duration-500"
                        x-transition:enter-start="opacity-0 transform scale-98"
                        x-transition:enter-end="opacity-100 transform scale-100"
                        x-transition:leave="transition duration-500"
                        x-transition:leave-start="opacity-100 transform scale-100"
                        x-transition:leave-end="opacity-0 transform scale-98"
                        class="flex justify-center items-center rounded py-1 px-3 border-2 border-[#2D2A4A] hover:cursor-pointer" @click.stop="next()">Next<span class="ml-1"><i class="fa-solid fa-angle-right"></i></span></button>
                    </div>
                </template>
                    <button 
                x-show="enable_chk_ans_btn"
                x-transition:enter="transition duration-500"
                x-transition:enter-start="opacity-0 transform scale-98"
                x-transition:enter-end="opacity-100 transform scale-100"
                class="flex justify-center rounded w-full p-3" :class=" enable_chk_ans_btn ? 'bg-[#2D2A4A] text-white' : 'bg-[#B3B3CC] text-gray-400' " @click.stop="checkAnswer()">Check Answer</button>
        </div>
        <a href="index.html" class="text-2xl p-1"><i class="fa-solid fa-house"></i></a>
        <span x-text="sliced_consonants"></span>
        <span x-text="question"></span>
        <span x-text="current_page"></span>
        <button @click.stop="clickNext()">Next</button>
    </div>
</body>
<script>
    window.speechSynthesis.onvoiceschanged = () => {
            window.speechSynthesis.getVoices();
    };
    document.addEventListener('alpine:init', () => {
        Alpine.data('dropdown', () => ({
            thai_consonants: [],
            consonant_count: 3,
            show_next: true,
            show_restart: false,
            show_cards: false,
            loading: false,
            flash: {},
            random_num: [],
            is_random: false,
            sliced_consonants: [],
            answer: null,
            show_result: false,
            enable_chk_ans_btn: false,
            show_next_btn: false,
            selected_answer: null,
            // correct_answer: 4,
            is_correct: null,
            selected_border_style: '',
            correct_border_style: '',
            question: '',
            choices: [],
            selected_box: null,
            current_page: 0,
            correct_answer: null,
            async init() {
                try {
                    const resp = await fetch("./thai.json")
                    const { thai_consonants } = await resp.json()
                    this.thai_consonants = thai_consonants
                    console.log(this.thai_consonants)
                } catch (error) {
                    console.error(error)
                }
            },
            random() {
                let ran = null;
                do {
                    if (this.random_num.length >= this.sliced_consonants.length) {
                        console.error('All possible values are already in the array. Exiting to avoid infinite loop.');
                        break; // Break to avoid infinite loop
                    }
                    ran = Math.floor(Math.random() * (this.sliced_consonants.length))

                } while (this.random_num.includes(ran));
                
                if (this.random_num.length < this.sliced_consonants.length) {
                    this.random_num.push(ran)
                }

                // this.toggleButton()
                this.flash = this.sliced_consonants[ran]

                this.loading = false
                this.show_cards = true

            },
            toggleButton() {
                if (this.random_num.length < this.sliced_consonants.length) {
                    this.show_restart = false;
                    setTimeout(() => {
                        this.show_next = true;
                    }, 300);
                }
                if (this.random_num.length >= this.sliced_consonants.length) {
                    this.show_next = false
                    setTimeout(() => {
                        this.show_restart = true;
                    }, 300);
                }
            },
            changeCount() {
                this.restart()
            },
            clickNext() {
                this.current_page ++
                this.question = this.sliced_consonants[this.current_page]
                // request text_to_speak by using the current question`

            },
            reset_everything() {
                this.selected_answer = ''
                this.show_result = false
            },
            resetPage() {
                this.current_page = 0
            },
            async generate() {
                try {
                    this.resetPage()
                    this.reset_everything()
                    this.show_cards = false
                    this.random_num = []
                    this.sliced_consonants = []

                    url = "http://127.0.0.1:5000/generate_quiz"
                    // consonant_count, is_random
                    const req_data = {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            consonant_count: this.consonant_count,
                            is_random: this.is_random
                        })
                    }
                    
                    const resp = await fetch(url, req_data)
                    const { generated_consonants, quiz } = await resp.json()
                    this.sliced_consonants = generated_consonants
                    this.question = quiz.question
                    this.choices = quiz.choices
                    // this.correct_answer = this.choices.find((ele, index) => ele.word == this.question)
                    this.assignCorrectAnswer()

                    this.loading = false
                    this.show_cards = true

                    // console.log('correct', this.correct_answer)
                    
                } catch (error) {
                    console.error(error)
                }
            },
            assignCorrectAnswer() {
                const index = this.choices.findIndex(ele => ele.word == this.question)
                if (index !== -1) {
                  this.correct_answer = {
                    index,
                    ...this.choices[index]
                  }  
                } else this.correct_answer = null

                console.log('asgsags', this.correct_answer)
            },
            speakAnswer(choice, index) {
                // play audio file
                console.log(choice.pronuncation)
                // assign index to answer
                // enable check answer btn
                if (!this.show_result) {
                    this.selected_border_style = 'border-[#2D2A4A]'
                    this.enable_chk_ans_btn = true
                    // this.selected_answer = choice.word
                    this.selected_answer = {
                        index,
                        ...choice
                    }
                    console.log(this.selected_answer)
                }
            },
            checkAnswer() {
                // check the selected answer
                // show the right/wrong result on top
                // show next btn
                this.enable_chk_ans_btn = false
                // if (this.correct_answer == this.selected_answer) {
                //     this.is_correct = true
                //     this.selected_border_style = 'border-green-300'
                // } else {
                //     this.is_correct = false
                //     this.selected_border_style = 'border-red-500'
                // }
                console.log(this.question, this.selected_answer)

                if (this.question == this.selected_answer.word) {
                    this.is_correct = true
                    this.selected_border_style = 'border-green-500'
                } else {
                    this.is_correct = false
                    this.selected_border_style = 'border-red-500'
                }
                this.correct_border_style = 'border-green-500'
                this.show_result = true

                // if (this.random_num.length < this.sliced_consonants.length) {
                    // this.show_restart = false;
                    // setTimeout(() => {
                console.log(this.current_page, this.sliced_consonants.length)
                if (this.current_page < (this.sliced_consonants.length - 1)) {
                        this.show_next_btn = true;
                    // }, 300);
                }
            },
            next() {
                console.log('first')
                this.loading = true
                this.show_result = false
                this.enable_chk_ans_btn = false
                this.show_next_btn = false
                this.selected_answer = {}
                this.is_correct = null
                this.selected_border_style = ''
                this.correct_border_style = ''
                // 
                // if (this.current_page ) {
                    
                // }
                this.current_page += 1
                this.question = this.sliced_consonants[this.current_page]
                // get quiz API
                this.loading = false
                // this.reset_everything()
                // this.show_cards = false
            },
            restart() {
                this.loading = true
                this.random_num = []
                setTimeout(() => {
                    this.random();
                }, 300);
            },
            readText(t) {
                if (!('speechSynthesis' in window)) {
                    console.error("Web Speech API not supported in this browser.");
                    return;
                }
                
                const text = this.$refs.text_to_read.textContent
                const speech = new SpeechSynthesisUtterance(t);

                speech.lang = 'th-TH';

                // Speak the text
                window.speechSynthesis.speak(speech);
            }
        }))
    })
</script>
</html>